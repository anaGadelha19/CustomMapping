<?php
$this->headLink()->appendStylesheet($this->assetUrl('node_modules/leaflet/dist/leaflet.css', 'CustomMapping'));
$this->headLink()->appendStylesheet($this->assetUrl('node_modules/leaflet.markercluster/dist/MarkerCluster.css', 'CustomMapping'));
$this->headLink()->appendStylesheet($this->assetUrl('node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css', 'CustomMapping'));
$this->headLink()->appendStylesheet($this->assetUrl('node_modules/leaflet.fullscreen/Control.FullScreen.css', 'CustomMapping'));
$this->headLink()->appendStylesheet($this->assetUrl('css/mapping.css', 'CustomMapping'));

$this->headScript()->appendFile($this->assetUrl('node_modules/leaflet/dist/leaflet.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('node_modules/leaflet.markercluster/dist/leaflet.markercluster-src.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('node_modules/leaflet-providers/leaflet-providers.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('node_modules/leaflet.fullscreen/Control.FullScreen.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('node_modules/Leaflet.Deflate/dist/L.Deflate.js', 'CustomMapping'));

$this->headScript()->appendFile($this->assetUrl('js/MappingModule.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('js/control.fit-bounds.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('js/mapping-browse.js', 'CustomMapping'));
$this->headScript()->appendFile($this->assetUrl('js/advanced-search.js', 'Omeka'));

$query['mapping_basemap_provider'] = $query['mapping_basemap_provider'] ?? '';

$legendTypes = [];
$featureTypes = $this->api()->search('custom_mapping_feature_types', ['sort_by' => 'label'])->getContent();
$legendItemsQuery = $itemsQuery;
$legendItemsQuery['site_id'] = $this->currentSite()->id();
$legendItemsQuery['has_features'] = true;
$legendItemsQuery['limit'] = 100000;
$legendItemIds = $this->api()->search('items', $legendItemsQuery, ['returnScalar' => 'id'])->getContent();
if ($legendItemIds) {
    $legendFeaturesQuery = $featuresQuery;
    $legendFeaturesQuery['item_id'] = $legendItemIds;
    $legendFeaturesQuery['per_page'] = 10000;
    $legendFeaturesQuery['page'] = 1;
    $legendFeatures = $this->api()->search('custom_mapping_features', $legendFeaturesQuery)->getContent();
    $usedTypeIds = [];
    foreach ($legendFeatures as $feature) {
        $type = $feature->featureType();
        if ($type) {
            $usedTypeIds[$type->id()] = true;
        }
    }
    if ($usedTypeIds) {
        foreach ($featureTypes as $featureType) {
            if (isset($usedTypeIds[$featureType->id()])) {
                $legendTypes[] = $featureType;
            }
        }
    }
}
?>
<?php echo $this->pageTitle($this->translate('Map'), 2); ?>

<div class="mapping-map-container" style="width: 80%; margin:0 auto;">
    <div id="mapping-map" style="height:700px;"
        data-disable-clustering="<?php echo $this->siteSetting('mapping_disable_clustering') ? '1' : '0'; ?>"
        data-basemap-provider="<?php echo $this->escapeHtml($this->siteSetting('mapping_basemap_provider')); ?>"
        data-features-url="<?php echo $this->escapeHtml($this->url('site/mapping', ['controller' => 'index', 'action' => 'get-features'], true)); ?>"
        data-feature-popup-content-url="<?php echo $this->escapeHtml($this->url('site/mapping', ['controller' => 'index', 'action' => 'get-feature-popup-content'], true)); ?>"
        data-items-query="<?php echo $this->escapeHtml(json_encode($itemsQuery)); ?>"
        data-features-query="<?php echo $this->escapeHtml(json_encode($featuresQuery)); ?>">
    </div>
    <?php if (!empty($legendTypes)): ?>
        <div class="mapping-map-legend" aria-label="<?php echo $this->translate('Map legend'); ?>">
            <div class="mapping-map-legend-title"><?php echo $this->translate('Legend'); ?></div>
            <ul class="mapping-map-legend-list">
                <?php foreach ($legendTypes as $featureType): ?>
                    <li class="mapping-map-legend-item">
                        <label class="mapping-map-legend-toggle">
                            <input type="checkbox" class="mapping-legend-toggle" data-type-id="<?php echo $this->escapeHtml($featureType->id()); ?>" checked>
                        </label>
                        <span class="mapping-map-legend-pin" aria-hidden="true">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill="<?php echo $this->escapeHtml($featureType->color()); ?>" d="M12 1.1a6.847 6.847 0 0 0-6.9 6.932c0 3.882 3.789 9.01 6.9 14.968 3.111-5.957 6.9-11.086 6.9-14.968A6.847 6.847 0 0 0 12 1.1zm0 9.9a3 3 0 1 1 3-3 3 3 0 0 1-3 3z"></path>
                            </svg>
                        </span>
                        <span class="mapping-map-legend-label"><?php echo $this->escapeHtml($featureType->label()); ?></span>
                    </li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>
</div>

<form id="advanced-search">
    <?php echo $this->partial('common/advanced-search', ['query' => $query, 'resourceType' => 'item']); ?>
    <button type="submit"><?php echo $this->translate('Search Map'); ?></button>
    <input type="hidden" name="mapping_basemap_provider" value="<?php echo $this->escapeHtml($query['mapping_basemap_provider']); ?>">
</form>
